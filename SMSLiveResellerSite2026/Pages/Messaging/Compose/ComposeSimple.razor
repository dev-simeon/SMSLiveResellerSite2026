@using Microsoft.AspNetCore.Components.Routing
@using SMSLiveResellerSite2026.Pages.Messaging.Compose.Modals
@using SMSLiveResellerSite2026.Components.Pages.ViewModels
@using SMSLiveResellerSite2026.Shared
@inject Settings settings;

<Loading NullCheckObject="model">
    <EditForm Model="model.Request" OnValidSubmit="SubmitMessage">
        <ValidationSummary class="text-danger" />
        <DataAnnotationsValidator />

        <div class="row g-4">

            <div class="col-lg-8">

                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <label for="senderId" class="form-label fw-bold">From (Sender ID)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa fa-user-check"></i></span>
                            <InputSelect class="form-select" id="senderId" @bind-Value="model.Request.SenderID">
                                @if (model.SenderIds == null)
                                {
                                    <option>Loading...</option>
                                }
                                else
                                {
                                    <option value="">Please select Sender ID</option>
                                    @foreach (var senderId in model.SenderIds)
                                    {
                                        <option value="@senderId">@senderId</option>
                                    }
                                }
                            </InputSelect>
                        </div>
                        <ValidationMessage class="text-danger" For="@(() => model.Request.SenderID)" />
                        <div class="form-text mt-2">
                            <NavLink class="text-decoration-none" href="/Messaging/SenderIds">
                                Click here to request for more SenderIDs
                            </NavLink>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h4 class="card-title">To (Recipients)</h4>

                        <RecipientList Caption="Raw Numbers" Recipients="model.Numbers" @onclick="e => rawNumberModal.Show()">
                            <button type="button" class="btn btn-outline-primary" @onclick="e => rawNumberModal.Show()">
                                <i class="fa fa-paste me-2"></i>Paste...
                            </button>
                            <p class="form-text">Type or paste your recipients phone numbers.</p>
                        </RecipientList>

                        <hr class="my-3">

                        <RecipientList Caption="From Contacts" Recipients="model.Contacts" @onclick="e => contactsModal.Show()">
                            <button type="button" class="btn btn-outline-primary" @onclick="e => contactsModal.Show()">
                                <i class="fa fa-user me-2"></i>Contacts...
                            </button>
                            <p class="form-text">Select numbers from your Phonebook or Groups.</p>
                        </RecipientList>

                        <hr class="my-3">

                        <RecipientList Caption="From Bulk Files" Recipients="model.BatchFiles" @onclick="e => bulkFileModal.Show()">
                            <button type="button" class="btn btn-outline-primary" @onclick="e => bulkFileModal.Show()">
                                <i class="fa fa-book me-2"></i>Bulk Files...
                            </button>
                            <p class="form-text">Include your Batch Files numbers.</p>
                        </RecipientList>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <label class="form-label fw-bold" for="messageText">What (Your Message)</label>
                            <span class="text-muted small">@model.CounterText</span>
                        </div>
                        <textarea class="form-control" id="messageText" rows="7"
                                  maxlength="@settings.MaxCharacter"
                                  @bind="model.Request.MessageText"
                                  @oninput="OnTextChange"></textarea>
                        <ValidationMessage class="text-danger" For="@(() => model.Request.MessageText)" />

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="form-text">
                                Messages longer than 160 characters are charged per page.
                            </div>
                            <button type="button" class="btn btn-link btn-sm text-danger" title="Clear Message" @onclick="ClearMessage">
                                <i class="fa fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-lg-4">
                <div class="sticky-top" style="top: 2rem;">

                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <label class="form-label fw-bold">When (Schedule)</label>
                            <InputRadioGroup @bind-Value="model.SendOption" class="mt-2">
                                <div class="form-check">
                                    <InputRadio class="form-check-input" id="r3" Value=@SendOption.SEND_NOW />
                                    <label class="form-check-label" for="r3">Send Immediately</label>
                                </div>
                                <div class="form-check">
                                    <InputRadio class="form-check-input" id="r4" Value=@SendOption.SEND_LATER />
                                    <label class="form-check-label" for="r4">Schedule for Later</label>
                                </div>
                            </InputRadioGroup>

                            @if (model.SendOption == SendOption.SEND_LATER)
                            {
                                <div class="mt-3">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fa fa-calendar-alt"></i></span>
                                        <InputDate class="form-control" id="s5"
                                                   Type="InputDateType.DateTimeLocal"
                                                   @bind-Value="model.Request.DeliveryTime" />
                                    </div>
                                    <div class="form-text mt-2">Your time zone is: West/Central Africa GMT +1</div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-body d-grid gap-2">
                            @if (model.SendOption == SendOption.SEND_NOW)
                            {
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fa fa-paper-plane me-2"></i>Send SMS Now!
                                </button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-info btn-lg">
                                    <i class="fa fa-clock me-2"></i>Queue Message
                                </button>
                            }

                            <div class="text-center text-muted mt-2">
                                <strong>Total Recipients: @model.TotalRecipientCount</strong>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </EditForm>

    <ContactsModal @ref="contactsModal" Model="model" OnSelected="OnSelected" />
    <BulkFilesModal @ref="bulkFileModal" Model="model" OnSelected="OnSelected" />
    <RawNumberModal @ref="rawNumberModal" Model="model" OnSelected="OnSelected" />
</Loading>

@code {
    private ContactsModal contactsModal = new();
    private BulkFilesModal bulkFileModal = new();
    private RawNumberModal rawNumberModal = new();

    private ComposeSimpleModel? model;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var t1 = apiClient.SenderIdListAsync(1, 500, null);
            var t2 = apiClient.BatchFileListAsync();
            var t3 = apiClient.ContactListAsync();

            await Task.WhenAll(t1, t2, t3);

            model = new(t1.Result.Result, t3.Result.Result, t2.Result.Result);
        }
        catch (Exception ex)
        {
            await alert.Error(ex.Message, "Error");
        }
    }

    private async Task SubmitMessage()
    {
        if (model == null) return;
        try
        {
            if (model.SendOption == SendOption.SEND_NOW) 
                model.Request.DeliveryTime = null;

            model.Request.PhoneNumbers = model.Contacts
                .Where(x => x.Selected).Select(x => x.Key).ToList();

            model.Request.BatchFileIDs = model.BatchFiles
                .Where(x => x.Selected).Select(x => x.Key).ToList();

            model.Request.RawNumbers = string.Join(",",
                model.Numbers.Select(x => x.Key));

            await apiClient.SmsBatchCreateAsync(model.Request);
        }
        catch (Exception ex)
        {
            await alert.Error(ex.Message, "Error");
        }
    }

    private void ClearMessage()
    {
        if (model == null) return;
        model.Request.MessageText = string.Empty;
        model.CounterText = "Type your Message here";
    }

    private void OnSelected()
    {
        model.UpdateRecipientCount();
        StateHasChanged();
    }

    private async Task OnTextChange(ChangeEventArgs e)
    {
        if (model == null) return;
        var strSmsText = e.Value?.ToString();
        model.CounterText = await ComposeExtensions.CountSmsMessages(alert, strSmsText, settings.SmsMaxParts);
    }
}